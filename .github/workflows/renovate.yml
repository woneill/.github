---
name: Renovate
on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:
    inputs:
      dryRun:
        description: Run Renovate in dry run mode
        required: false
        type: boolean
        default: true
      repo:
        description: Repository to run Renovate on
        required: false
        type: string
      logLevel:
        description: Log level for Renovate
        required: false
        type: choice
        default: info
        options:
          - info
          - debug

jobs:
  renovate:
    runs-on: ubuntu-latest
    steps:
      - name: Get token
        id: get_token
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2
        with:
          private-key: ${{ secrets.PRIVATE_KEY }}
          app-id: ${{ secrets.APP_ID }}
          owner: ${{ github.repository_owner }}

      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Self-hosted Renovate
        uses: renovatebot/github-action@2d941ef4e268e53affdc1f11365c69a73e544f50 # v43.0.14
        with:
          configurationFile: renovate-config.js
          token: "${{ steps.get_token.outputs.token }}"
          env-regex: "^(?:RENOVATE_\\w+|LOG_LEVEL|REPOLIST|DOCKERHUB_USERNAME|DOCKERHUB_TOKEN)$"
        env:
          RENOVATE_DRY_RUN: ${{ contains(inputs.dryRun, 'true') && 'full' || '' }}
          REPOLIST: ${{ inputs.repo != '' && inputs.repo || '' }}
          LOG_LEVEL: ${{ inputs.logLevel != '' && inputs.logLevel || 'info' }}
          DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          GITHUB_TOKEN: ${{ steps.get_token.outputs.token }}
