---
name: Renovate
on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:
    inputs:
      dryRun:
        description: Run Renovate in dry run mode
        required: false
        type: boolean
        default: true
      repo:
        description: Repository to run Renovate on
        required: false
        type: string
      logLevel:
        description: Log level for Renovate
        required: false
        type: choice
        default: info
        options:
          - info
          - debug

jobs:
  renovate:
    runs-on: ubuntu-latest
    steps:
      - name: Get token
        id: get_token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
        with:
          private-key: ${{ secrets.PRIVATE_KEY }}
          app-id: ${{ secrets.APP_ID }}
          owner: ${{ github.repository_owner }}

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Self-hosted Renovate
        uses: renovatebot/github-action@d65ef9e20512193cc070238b49c3873a361cd50c # v46.1.1
        with:
          configurationFile: renovate-config.js
          token: "${{ steps.get_token.outputs.token }}"
          env-regex: "^(?:RENOVATE_\\w+|LOG_LEVEL|REPOLIST|DOCKERHUB_USERNAME|DOCKERHUB_TOKEN)$"
        env:
          RENOVATE_DRY_RUN: ${{ contains(inputs.dryRun, 'true') && 'full' || '' }}
          REPOLIST: ${{ inputs.repo != '' && inputs.repo || '' }}
          LOG_LEVEL: ${{ inputs.logLevel != '' && inputs.logLevel || 'info' }}
          DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          GITHUB_TOKEN: ${{ steps.get_token.outputs.token }}
